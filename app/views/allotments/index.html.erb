<% provide(:title, 'All Allotments') %>

<main class="page-body allotment">
  <%= render "shared/flash" %>
  
  <div class ="d-flex justify-content-between">
    <div>
      <%= search_form_for @q do |f| %> 
        <div class="input-group">
          <div class="form-outline">
            <%= f.text_field :item_name_cont, class: 'form-control', placeholder: 'search by Item name' %> 
          </div>
          <%= f.submit class: 'btn  btn-sm btn-secondary' %>
        </div>
      <%end%>
    </div>
    <% if current_user.admin? %>
      <div>
        <%= search_form_for @q do |f| %> 
          <div class="input-group">
            <div class="form-outline">
              <%= f.collection_select(:user_name_cont, User.all,  :name, :email, include_blank: '--filter by email--', class: 'form-control') %> 
            </div>
            <%= f.submit 'Apply', class: 'btn btn-sm btn-secondary' %>
          </div>
        <%end%>
      </div>

      <div>
        <%= link_to "Make New Allotment", new_allotment_path, class:"btn btn-primary" %>
      </div> 
    <% end %>
  </div>
  

  <% if !@allotments.blank? %>
    <h2>Allotment History</h2>
      <div class="container-fluid">
        <table class="table table-striped table-hover table-bordered text-center">
          <thead class="table-dark">
            <tr>
              <th>User</th>
              <th>Item</th>
              <th>Allotment quantity</th>
              <th><%= sort_link(@q, :created_at, 'Allotted at', class: "text-white") %></th>
              <th><%= sort_link(@q, :dealloted_at, 'Deallocated at', class: "text-white") %></th>
              <% if current_user.admin? %>
                <th></th>
              <% end %>
            </tr>
          </thead>

          <tbody>
            <% @allotments.each do |allotment| %>
              <% @item = get_item_by_id allotment.item_id %>
              <tr>
                <td>
                <% if current_user.admin? %>
                  <%= link_to "#{get_user_name_by_id allotment.user_id}", users_allotment_path(allotment) %>
                <% else %>
                  <%= get_user_name_by_id allotment.user_id %>
                <% end %>
                </td>
                <td>
                  <%= item_display_name @item %>
                </td>
                <td>
                  <%= allotment.allotment_quantity %>
                </td>
                <td>
                  <%= allotment.created_at.strftime("%d-%m-%Y %H:%M:%S") %>
                </td>
                <td>
                  <%= get_deallotment_status allotment %>
                </td>
                <% if current_user.admin? %>
                <td>
                  <% if allotment.dealloted_at.blank? %>
                    <%= link_to "Deallot", deallot_allotment_path(allotment), class: "btn btn-warning" %>
                  <% end %>                      
                </td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
  <% else %> 
    <p class="text-center">
      <%= Current.user.admin? ? "NO allotment have been made till now. Click /'Add Allotment'/ button to make new allotment." : "NO allotment have been made till now." %>
    </p>    
  <% end %>  
</main>