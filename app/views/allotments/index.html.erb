<% provide(:title, 'All Allotments') %>

<main class="page-body allotment">
  <%= render "shared/flash" %>
  <div class="d-flex justify-content-end">
    <% if current_user.admin %>
      <%= link_to "Add Allotment", new_allotment_path, class:"btn btn-primary" %>
    <% end %>
  </div>
  
  <div class ="d-flex bd-highlight">
    <%# search bar %>
    <div class="card flex-shrink-1 bd-highlight search-card" style="width: 16rem;">
      <div class="card-body">
        <%= search_form_for @q do |f| %> 
          <div class="input-group d-flex flex-column justify-content-between">
            <div class="form-outline">
              <%= f.text_field :item_name_cont, class: 'form-control', placeholder: 'search Item name' %> 
              <% if current_user.admin %>
                <%= f.label :user_name_cont, "Filter:", class: 'form-label' %>
                <%= f.collection_select :user_name_cont, User.all,  :name, :email, {include_blank: '--select email--'}, {class: 'form-control'} %> 
              <% end %>
            </div>
            <div class="mt-3">
              <%= f.submit class: 'btn btn-secondary' %>
            </div>          
          </div>
        <%end%>
      </div>
    </div>


    <%# main content %>
    <div class="w-100 bd-highlight">
      <% if !@allotments.blank? %>
        <h2>Allotment History</h2>
          <div class="container-fluid">
            <table class="table table-striped table-hover table-bordered text-center">
              <thead>
                <tr>
                  <th>User</th>
                  <th>Item</th>
                  <th>Allotment quantity</th>
                  <th><%= sort_link(@q, :created_at, 'Allotted at') %></th>
                  <th><%= sort_link(@q, :dealloted_at, 'Deallocated at') %></th>
                  <% if current_user.admin && any_allotment? %>
                    <th></th>
                  <% end %>
                </tr>
              </thead>

              <tbody id="allotments-table">
                <% @allotments.each do |allotment| %>
                  <% @item = get_item_by_id allotment.item_id %>

                  <%= render "allotment_row", allotment: allotment, item: @item %>
                  
                <% end %>
              </tbody>
            </table>
          </div>
      <% else %> 
        <p class="text-center">
          <%= Current.user.admin ? "NO allotment have been made till now. Click /'Add Allotment'/ button to make new allotment." : "NO allotment have been made till now." %>
        </p>    
      <% end %> 
    </div>   
</main>


